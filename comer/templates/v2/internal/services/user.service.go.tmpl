/*
generated by comer,https://github.com/imoowi/comer
Copyright © 2023 jun<simpleyuan@gmail.com>
*/
package services

import (
	"errors"

	"github.com/gin-gonic/gin"
	"github.com/imoowi/comer/utils/maker"
	"github.com/imoowi/comer/utils/password"
	"{{.moduleName}}/internal/global"
	"{{.moduleName}}/internal/middlewares/token"
	"{{.moduleName}}/internal/models"
	"{{.moduleName}}/internal/repos"
	"github.com/spf13/cast"
	"github.com/imoowi/comer/interfaces"
	"github.com/imoowi/comer/interfaces/impl"
)

var User *UserService

type UserService struct {
	impl.Service
}

func NewUserService(r *repos.UserRepo) *UserService {
	return &UserService{
		Service: *impl.NewService(r),
	}
}
func init() {
	RegisterServices(func() {
		User = NewUserService(repos.User)
		var mt interfaces.IModel = &models.User{}
		User.MT = &mt
	})
}
func (s *UserService) OneByUsername(c *gin.Context, username string) (model *models.User, err error) {
	return repos.User.OneByUsername(c, username)
}
func (s *UserService) Add(c *gin.Context, _model *models.UserAdd) (newId uint, err error) {
	var f interfaces.IFilter = &models.UserFilter{}
	_admin, _ := s.One(c, &f, c.GetUint(`uid`), s.MT)
	// 角色是否存在？
	var mt interfaces.IModel = &models.Role{}
	var fr interfaces.IFilter = &models.RoleFilter{}
	role, _ := Role.One(c, &fr, _model.RoleId, &mt)
	if role == nil || (*role).GetID() <= 0 {
		newId = 0
		err = errors.New(`角色不存在`)
		return
	}
	// 用户是否存在？
	model, _ := repos.User.OneByUsername(c, _model.Username)
	if model != nil && model.ID > 0 {
		newId = 0
		err = errors.New(`用户名已经存在`)
		return
	}
	salt := maker.MakeRandStr(6)
	newUser := &models.User{
		UserBase: models.UserBase{
			Username: _model.Username,
			// Passwd:   _model.Passwd,
			Passwd: password.GeneratePassword(_model.Passwd + salt),
			Salt:   salt,
		},
	}
	var newUserModel interfaces.IModel = newUser
	newId, err = s.Service.Add(c, &f, &newUserModel, s.MT)
	if newId > 0 {
		// 插入用户和角色关系
		var userrole interfaces.IModel = &models.UserRole{UserID: newId, RoleId: _model.RoleId}
		var fur interfaces.IFilter = &models.UserRoleFilter{}
		var urmt interfaces.IModel = &models.UserRole{}
		UserRole.Add(c, &fur, &userrole, &urmt)

		//*
		go func(c *gin.Context, _model *models.UserAdd, newId uint) {

			admin := (*_admin).(*models.User)
			if admin.GetID() > 0 {
				var userlog interfaces.IModel = &models.UserLog{
					UserID:     admin.GetID(),
					LogType:    global.USER_LOG_TYPE_ADD,
					ResType:    global.RES_TYPE_USER,
					LogContent: `管理员【` + admin.Username + `】添加了用户【` + cast.ToString(newId) + `】`,
					IP:         c.ClientIP(),
				}
				var ful interfaces.IFilter = &models.UserLogFilter{}
				var ulmt interfaces.IModel = &models.UserLog{}
				UserLog.Add(c, &ful, &userlog, &ulmt)
			}
		}(c, _model, newId)
		//*/

	}
	return
}
func (s *UserService) Login(c *gin.Context, login *models.UserLogin) (user *models.User, err error) {
	user, err = repos.User.Login(c, login)
	return
}
func (s *UserService) Logout(c *gin.Context, token string) bool {
	// err := global.Redis.SAdd(c, JwtTokenBlackListSetKey, token).Err()
	var err error
	var fu interfaces.IFilter = &models.UserFilter{}
	_admin, _ := repos.User.One(c, &fu, c.GetUint(`uid`), s.MT)
	if (*_admin).GetID() > 0 {
		admin := (*_admin).(*models.User)
		go func(c *gin.Context, admin *models.User) {
			var userlog interfaces.IModel = &models.UserLog{
				UserID:     admin.ID,
				LogType:    global.USER_LOG_TYPE_USER_LOGOUT,
				ResType:    global.RES_TYPE_USER,
				LogContent: `用户【` + admin.Username + `】退出了系统`,
				IP:         c.ClientIP(),
			}
			var ful interfaces.IFilter = &models.UserLogFilter{}
			var umt interfaces.IModel = &models.UserLog{}
			UserLog.Add(c, &ful, &userlog, &umt)
		}(c, admin)
	}
	return err == nil
}

func (s *UserService) ChgPwd(c *gin.Context, userChgPwd *models.UserChgPwd) (newToken string, err error) {
	var fu interfaces.IFilter = &models.UserFilter{}
	_admin, _ := repos.User.One(c, &fu, c.GetUint(`uid`), s.MT)
	ok, err := repos.User.ChgPwd(c, userChgPwd)
	if err == nil && ok {
		if (*_admin).GetID() > 0 {
			admin := (*_admin).(*models.User)
			newToken, _ = token.GenToken(admin.Username, admin.ID)
			go func(c *gin.Context, admin *models.User) {
				var userlog interfaces.IModel = &models.UserLog{
					UserID:     admin.ID,
					LogType:    global.USER_LOG_TYPE_USER_CHGPWD,
					ResType:    global.RES_TYPE_USER,
					LogContent: `用户【` + admin.Username + `】修改了密码`,
					IP:         c.ClientIP(),
				}
				var ful interfaces.IFilter = &models.UserLogFilter{}
				var ulmt interfaces.IModel = &models.UserLog{}
				UserLog.Add(c, &ful, &userlog, &ulmt)
			}(c, admin)
		}
	}
	return
}

const JwtTokenBlackListSetKey = `lynkros-monitor:jwt:token:blacklist`

func (s *UserService) IsLogouted(c *gin.Context, token string) bool {
	// ok, _ := global.Redis.SIsMember(c, JwtTokenBlackListSetKey, token).Result()
	var ok bool
	return ok
}
func (s *UserService) IsSuper(c *gin.Context, userId uint) bool {
	userRoles, err := UserRole.AllByUserId(c, userId)
	if err != nil {
		return false
	}
	if len(userRoles) <= 0 {
		return false
	}
	for _, v := range userRoles {
		var fr interfaces.IFilter = &models.RoleFilter{}
		var mtr interfaces.IModel = &models.Role{}
		_role, err := Role.One(c, &fr, v.RoleId, &mtr)
		if err != nil {
			continue
		}
		role := (*_role).(*models.Role)
		if role.Level == models.ROLE_LEVEL_SUPER {
			return true
		}
	}
	return false
}
func (s *UserService) UserRoleIds(c *gin.Context, userId uint) []uint {
	userRoleIds, err := UserRole.AllIdsByUserId(c, userId)
	if err != nil {
		return make([]uint, 0)
	}
	if len(userRoleIds) > 0 {
		return userRoleIds
	}
	return make([]uint, 0)
}
func (s *UserService) UserRolesByUid(c *gin.Context, userId uint) (roles []*models.Role) {
	userRoles, err := UserRole.AllByUserId(c, userId)
	if err != nil {
		return nil
	}
	if len(userRoles) <= 0 {
		return nil
	}
	for _, v := range userRoles {
		var fr interfaces.IFilter = &models.RoleFilter{}
		_role, err := Role.One(c, &fr, v.RoleId, s.MT)
		if err != nil {
			continue
		}
		role := (*_role).(*models.Role)
		roles = append(roles, role)
	}
	return
}
