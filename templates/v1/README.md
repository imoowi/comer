# {{.moduleName}}
## 一、⭐！强制规则
- 数据库选择MySql
- 必须使用迁移：数据库字段的修改必须通过gorm的数据迁移来实现,禁止手动改数据库，数据迁移参考文档[gorm迁移](https://gorm.io/zh_CN/docs/migration.html)
- 必须要有/migrates/[modelName].migrate.go文件：每个模块(module)下的模型(model)里必须要有与之对应的[modelName].migrate.go文件
- 运行项目前，必须在项目根目录执行以下数据迁移命令
```sh
cd project_root
go run . migrate
#或者
{{.projectCommand}} migrate
```
    会自动产生以下内容
```sql
2023/06/01 10:25:26 migrate start.
Connected to MySql!

2023/06/01 10:25:26 C:/Users/simpl/dev/golang/com.lynkros.gitlab/{{.projectCommand}}/internal/modules/test/models/mysql.migrate.go:23
[1.724ms] [rows:-] SELECT DATABASE()

2023/06/01 10:25:26 C:/Users/simpl/dev/golang/com.lynkros.gitlab/{{.projectCommand}}/internal/modules/test/models/mysql.migrate.go:23
[19.405ms] [rows:1] SELECT SCHEMA_NAME from Information_schema.SCHEMATA where SCHEMA_NAME LIKE 'lynkros_builder%' ORDER BY SCHEMA_NAME='lynkros_builder' DESC,SCHEMA_NAME limit 1

2023/06/01 10:25:26 C:/Users/simpl/dev/golang/com.lynkros.gitlab/{{.projectCommand}}/internal/modules/test/models/mysql.migrate.go:23
[5.867ms] [rows:-] SELECT count(*) FROM information_schema.tables WHERE table_schema = 'lynkros_builder' AND table_name = 'products' AND table_type = 'BASE TABLE'

2023/06/01 10:25:26 C:/Users/simpl/dev/golang/com.lynkros.gitlab/{{.projectCommand}}/internal/modules/test/models/mysql.migrate.go:23
[48.844ms] [rows:0] CREATE TABLE `products` (`id` bigint unsigned AUTO_INCREMENT,`created_at` datetime(3) NULL,`updated_at` datetime(3) NULL,`deleted_at` datetime(3) NULL,`code` longtext,`pri                   ice` bigint unsigned,PRIMARY KEY (`id`),INDEX `idx_products_deleted_at` (`deleted_at`))

2023/06/01 10:25:26 migrate end.
```

## 二、代码生成器
- 命令如下
```sh
#--module=[模块名，必须输入] --swaggerTags=[接口文档Tags] --controller=[控制器名，默认为模块名] --service=[服务名，默认为控制器名] --model=[模型名1,模型名2,模型名...;默认取第一个生成service]
go run . generator --module=base --swaggerTags='cpn(空间单元)' --controller=cpn --service=cpn --model=user,role,department,right
#或者
{{.projectCommand}} generator --module=department
```

## 三、本系统脚手架使用步骤
### 步骤一、生成模块代码
```sh
go run . generator --module=user
#或者
{{.projectCommand}} generator --module=user
```
### 步骤二、修改数据表定义文件"xxx.model.go"
```go
//将以下内容
// generated by "{{.projectCommand}} generator"
package models

import "gorm.io/gorm"

// 用户表
type User struct {
	gorm.Model
	Username string `json:"username" form:"username" gorm:"column:username;type:varchar(50);not null" binding:"required"`
}

//修改为
// generated by "{{.projectCommand}} generator"
package models

import "gorm.io/gorm"

// 用户表
type User struct {
	gorm.Model
	Username string `json:"username" form:"username" gorm:"column:username;type:varchar(50);not null" binding:"required"`  //用户名
	Passwd   string `json:"password" form:"password" gorm:"column:password;type:varchar(255);not null" binding:"required"` //密码
	Salt     string `json:"salt" form:"salt" gorm:"column:salt;type:varchar(6);not null"  `                                //盐
	MpOpenid string `json:"mp_openid" form:"mp_openid" gorm:"column:mp_openid;type:varchar(50)"  `
}

// 登录表单
type UserLogin struct {
	Username string `json:"username" form:"username" binding:"required"`
	Passwd   string `json:"password" form:"password" binding:"required"`
}

```
### 步骤三、数据迁移：生成目标表（只新增，不做删除）
```sh
go run . migrate -c ./config/settings-local.yml
#或者
{{.projectCommand}} migrate -c ./config/settings-local.yml
```
### 步骤四、初始化系统
```sh
go run . init -c ./config/settings-local.yml
#或者
{{.projectCommand}} init -c ./config/settings-local.yml
```
### 步骤五、生成swagger文档
```sh
swag init
```
### 步骤六、查看文档：运行以下命令，然后访问[http://localhost:18000/swagger/index.html](http://localhost:18000/swagger/index.html)
```sh
go run . server
#或者
air
```

## 代码生成历史
```sh
go run . generator --module=user 
go run . generator --module=base --swaggerTags='cpn(空间单元)' --controller=cpn
go run . generator --module=base --swaggerTags='cpnType(空间单元类型)' --controller=cpnType --model=baseCpnType
go run . generator --module=base --swaggerTags='deviceType(设备类型)' --controller=deviceType --model=baseDeviceType
go run . generator --module=base --swaggerTags='cpnDevice(空间单元下的设备)' --controller=cpnDevice --model=baseCpnDevice
go run . generator --module=base --swaggerTags='cpnParam(空间单元下的信息)' --controller=cpnParam --model=baseCpnParam
go run . generator --module=project --swaggerTags='project(项目)' --controller=project 
go run . generator --module=project --swaggerTags='project(项目与用户关联)' --controller=projectUser
go run . generator --module=project --swaggerTags='project(项目信息模型)' --controller=projectCpn --model=projectCpn
go run . generator --module=project --swaggerTags='projectCpnDevice(项目设备)' --controller=projectCpnDevice
go run . generator --module=project --swaggerTags='projectCpnParam(项目信息)' --controller=projectCpnParam
go run . generator --module=project --swaggerTags='projectPage(项目页面)' --controller=projectPage
go run . generator --module=project --swaggerTags='projectPageHistory(项目页面历史记录)' --controller=projectPageHistory
go run . generator --module=project --swaggerTags='projectLog(项目操作记录)' --controller=projectLog
go run . generator --module=project --swaggerTags='projectShareLog(项目分享记录)' --controller=projectShareLog
go run . generator --module=project --swaggerTags='projectWarningConfig(项目报警配置)' --controller=projectWarningConfig
go run . generator --module=project --swaggerTags='projectWarningConfigRule(项目报警配置规则)' --controller=projectWarningConfigRule
go run . generator --module=device --swaggerTags='device(设备)' --controller=resource
```